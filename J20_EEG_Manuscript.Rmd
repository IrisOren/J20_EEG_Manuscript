---
title: "J20_EEG_Manuscript"
author: "Iris Oren"
date: "19/12/2016"
output: html_document
---


### Description
This .rmd file processes the data to create all figures for Brown & Ying et a

* Data
  + Spike counts by SCPP1V1: SCPP1V1.tcl was run on 8s epochs of data, with glitch=200. The processor generated text files, containing spike counts, theta and delta power. SCPP1V1.tcl outputs: "ndfFilename_SCPP1V1.txt", organised in individual folders by animalID (Raw data: Dropbox/Analysis/Neuroarchiver/J20EEG/SCPP1V1).
  + Spike counts by Matthias's scripts: To be added
  + Metadata: RecordingInformationJ20_Saved180816.csv
  + Abeta load data: to be added
  + Chat data: to be added
  + AChE data: to be added



###Package Initialisation 

First, load packages and source files
```{r LoadPackages_Chunk, echo=FALSE, include=FALSE}
library(lubridate)
library(dplyr)
library(lazyeval) #Needed for using ggplot2 library
library(ggplot2)
library(cowplot)
library(stringr)
library(scatterplot3d)
library(data.table)


sourceDir <- function(path, trace = TRUE, ...) {
    for (nm in list.files(path, pattern = "\\.[Rr]$")) {
       if(trace) cat(nm,":")           
       source(file.path(path, nm), ...)
       if(trace) cat("\n")
    }
}
sourceDir("R/")  #All function in R/ folder relative to project
```
### Datafile and variable initialisation
Specify files and folders to be used
```{r VariableInitialisationChunk, ECHO=FALSE}
NDFDataParentFolder<-"~/Dropbox/ANALYSIS/J20_EEG_Manuscript/Data/SCPP1V1_TCL"
RecordingInfoFile<-"./Data/RecordingInfo.csv"
```

Import summary recording information dataframe
```{r ImportRecordingInformation, ECHO=FALSE, include=FALSE}

summary_dataframe<-read.csv(RecordingInfoFile, na = "empty")
summary_dataframe$animalID<-as.character(summary_dataframe$animalID)
summary_dataframe$drug_date<-as.character(summary_dataframe$drug_date)
summary_dataframe$drug_time<-as.character(summary_dataframe$drug_time)
summary_dataframe$time_zone<-as.character(summary_dataframe$time_zone) #Set to "Europe/london" except for animals when clocks changed from GMT-> daylight savings and they stayed on GMT which should be set to "UTC" 
summary_dataframe$drug_date_time<-  paste(as.character(summary_dataframe$drug_date)
, as.character(summary_dataframe$drug_time), " ")


```


### Figure 1: Spike rate between genotype

This figure requires a dataframe Fig1_summary_dataframe=animalID|genotype|time_zone|spike_rate

Steps:
1. Create fig1_dataframe from recordingInformation
```{r create_fig1_dataframe, ECHO=FALSE, include=FALSE}
  fig1_summary_dataframe<-summary_dataframe[, c("animalID", "genotype", "time_zone", "drug_date_time")]
```
  

2. For each AnimalID:
  i. Set AnimalID subfolder
  ii. Create SCPPP1_dataframe from all NDFFileName_SCPP1V1.txt files 
  iii. Add variables for time and for separating drug and treatment conditions
  iv. Exclude loss intervals
  v. Save to a list with elements accessed by animalID

  
  
```{r ImportAndTransformNDFOutput_chunk, ECHO=FALSE, include=FALSE}

#Initialise variables for current subject
SCPP1_dataframe_list<-list()

#SpikeCount_x <- c()
#SpikeCount_ID <- as.factor(c())
#SpikeCount_genotype <- as.factor(c())
for(i in 1:nrow(fig1_summary_dataframe)){     #Loop through animals
#for(i in 1:10){
 #Write animalID, genotype and time_zone to current animal
        animalID_current<-fig1_summary_dataframe$animalID[i]
        genotype_current<-fig1_summary_dataframe$genotype[i]
        time_zone_current<-fig1_summary_dataframe$time_zone[i]
        drug_date_time_current<-fig1_summary_dataframe$drug_date_time[i] 
  #i. Set AnimalID subfolder
  
  full_path<-paste(NDFDataParentFolder, animalID_current, sep="/")
  
    #Next import all files in input_path to create a new r dataframe called             `SCPP1_dataframe'
    SCPP1_dataframe<-ImportData(full_path)
  
  #Apend time information to data frame  
    SCPP1_dataframe <- GetTimeOfDayAndDate(SCPP1_dataframe, time_zone_current)


    #Apend treatment variable 
    Treatment<-c()
    Treatment[which(SCPP1_dataframe$TimeOfDay<strptime(drug_date_time_current, "%Y-%m-%d %H:%M:%S"))]="Control"
    Treatment[length(Treatment)+1]="Unknown"
    Treatment[(length(Treatment)+1):(dim(SCPP1_dataframe))[1]]="Drug"
    SCPP1_dataframe<-cbind(SCPP1_dataframe, Treatment)
    # Exclude Loss and Artifact intervals
    SCPP1_dataframe <- ExcludeIntervals(SCPP1_dataframe, 3)

    #Save SCPP1_dataframe to have current animalID and export
    SCPP1_dataframe_all_list[[animalID_current]]<-SCPP1_dataframe
  
}
```

## Compare spike rate data between animals in control condition

First, select for control condition
```{r SelectControlCondition_Chunk, echo=FALSE, include=FALSE}
SCPP1_dataframe_list_control<-list()
for(i in 1:nrow(fig1_summary_dataframe))
        SCPP1_dataframe_list_control[[i]]<-filter(SCPP1_dataframe_list[[i]], Treatment=="Control")
```


  iv. Create data frame with empirical cumulative distribution for each animal in control conditions
```{r Create_ECDFs_chunk, echo=FALSE, include=FALSE}
ECDF_list<-list()

for (j in 1:nrow(fig1_summary_dataframe)){
  animalID_current<-fig1_summary_dataframe$animalID[j]
  genotype_current<-fig1_summary_dataframe$genotype[j]
  dataframe_current<-SCPP1_dataframe_list_control[[j]]
  
  
  ECDF_current <-CreateECDF(dataframe_current, genotype_current, animalID_current)
  ECDF_list[[fig1_summary_dataframe$animalID[j]]]<-ECDF_current  #A list of all ECDFs for each animal. Accessed by animalIDs in fig1_summary_dataframe$AnimalID
   }
```


```{r ECDF_PlotChunk, echo=FALSE, include=FALSE}  
  #Plot ECDF for all animals in control conditions


    #First, combine all elements of ECDF_list into a single dataframe
    ECDF_df_all<-rbindlist(ECDF_list)


#Now create separate DFs for each genotype using filter
ecdf_df_J20<-filter(ECDF_df_all, Genotype=="J20")
ecdf_df_WT<-filter(ECDF_df_all, Genotype=="WT")


ecdf_WT_plot<-ggplot(ecdf_df_WT, aes(x=SpikeCount, y=CumFrequency, color=AnimalID))
ecdf_WT_plot<-ecdf_WT_plot +
  geom_step() + xlab("Number of spikes") + ylab("Number of intervals")


ecdf_plot_all<-ggplot(ECDF_df_all, aes(x=SpikeCount, y=CumFrequency, color=AnimalID))
ecdf_plot_all<-ecdf_plot_all + geom_step() + xlab("Number of spikes") + ylab("Number of intervals") + facet_wrap(~Genotype)

ecdf_plot_all


```



``` {r ECDF_stats_chunk, ECHO=FALSE, include=FALSE}
ZeroSpikeIntervals_WT <- filter(ecdf_df_WT, SpikeCount==0)
ZeroSpikeIntervals_WT$CumFrequencyComplement=1-ZeroSpikeIntervals_WT$CumFrequency



ZeroSpikeIntervals_J20 <- filter(ecdf_df_J20, SpikeCount==0)
ZeroSpikeIntervals_J20$CumFrequencyComplement=1-ZeroSpikeIntervals_J20$CumFrequency
mean(ZeroSpikeIntervals_J20$CumFrequencyComplement)

```

```{r CompareECDFStats, echo=FALSE}
PercGreaterOneSpike_WT<-ZeroSpikeIntervals_WT$CumFrequencyComplement
PercGreaterOneSpike_J20<-ZeroSpikeIntervals_J20$CumFrequencyComplement
#Compare PercGreaterOneSpike in WT and J20

###TO DO: WRITE SCRIPT TO
###A) CHECK TEST ASSUMPTIONS FOR PARAMETRIC 
###B) PERFORM PARAMETRIC TESTS
#REPORT SUMMARY STATS FOR TEST OF CHOICE
#WRITE UP AS WOULD BE IN PAPER TO ENSURE THAT YOU HAVE RELEVANT STATS

