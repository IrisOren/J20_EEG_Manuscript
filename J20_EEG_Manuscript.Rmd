---
title: "J20_EEG_Manuscript"
author: "Iris Oren"
date: "19/12/2016"
output: html_document
---


### Description
This .rmd file processes the Data to create all figures for Brown & Ying et a

* Data
  + Spike counts by SCPP1V1: SCPP1V1.tcl was run on 8s epochs of Data, with glitch=200. The processor generated text files, containing spike counts, theta and delta power. SCPP1V1.tcl outputs: "ndfFilename_SCPP1V1.txt", organised in individual folders by AnimalID (Raw Data: Dropbox/Analysis/Neuroarchiver/J20EEG/SCPP1V1).
  + Spike counts by Matthias's scripts: To be added
  + Metadata: RecordingInformationJ20_Saved180816.csv
  + Abeta load Data: to be added
  + Chat Data: to be added
  + AChE Data: to be added



###Package Initialisation 

First, load packages and source files
```{r LoadPackages_Chunk, echo=FALSE, include=FALSE}
library(lubridate)
library(dplyr)
library(lazyeval) #Needed for using ggplot2 library
library(ggplot2)
library(cowplot)
library(stringr)
library(scatterplot3d)
library(data.table)
library(perm)


sourceDir <- function(path, trace = TRUE, ...) {
    for (nm in list.files(path, pattern = "\\.[Rr]$")) {
       if(trace) cat(nm,":")           
       source(file.path(path, nm), ...)
       if(trace) cat("\n")
    }
}
sourceDir("R/")  #All function in R/ folder relative to project
```
### Datafile and variable initialisation
Specify files and folders to be used
```{r VariableInitialisationChunk, ECHO=FALSE}
NDFDataParentFolder<-"~/Dropbox/ANALYSIS/J20_EEG_Manuscript/Data/SCPP1V1_TCL"
RecordingInfoFile<-"./Data/RecordingInfo.csv"
```

Import summary recording information dataframe
```{r ImportRecordingInformation, ECHO=FALSE, include=FALSE}

SummaryDataframe<-read.csv(RecordingInfoFile, na = "empty")
SummaryDataframe$AnimalID<-as.character(SummaryDataframe$AnimalID)
SummaryDataframe$DrugDate<-as.character(SummaryDataframe$DrugDate)
SummaryDataframe$DrugTime<-as.character(SummaryDataframe$DrugTime)
SummaryDataframe$TimeZone<-as.character(SummaryDataframe$TimeZone) #Set to "Europe/london" except for animals when clocks changed from GMT-> daylight savings and they stayed on GMT which should be set to "UTC" 
SummaryDataframe$DrugDateTime<-  paste(as.character(SummaryDataframe$DrugDate)
, as.character(SummaryDataframe$DrugTime), " ")


```


# Figure 1: Spike rate between genotype

This figure requires a dataframe Fig1SummaryDataframe=AnimalID|Genotype|TimeZone|SpikeRate

Steps:
1. Create Fig1SummaryDataframe from recordingInformation
```{r create_fig1_dataframe, ECHO=FALSE, include=FALSE}
  Fig1SummaryDataframe<-SummaryDataframe[, c("AnimalID", "Genotype", "TimeZone", "DrugDateTime")]
```
  

2. For each AnimalID:
  i. Set AnimalID subfolder
  ii. Create SCPPP1_dataframe from all NDFFileName_SCPP1V1.txt files 
  iii. Add variables for time and for separating drug and treatment conditions
  iv. Exclude loss intervals
  v. Save to a list with elements accessed by AnimalID

  
  
```{r ImportAndTransformNDFOutput_chunk, ECHO=FALSE, include=FALSE}

#Initialise variables for current subject
SCPP1DataframeList<-list()
SCPP1DataframeAll<-data.frame()

#spikeCount_x <- c()
#spikeCount_ID <- as.factor(c())
#spikeCount_genotype <- as.factor(c())
for(i in 1:nrow(Fig1SummaryDataframe)){     #Loop through animals

  SCPP1Dataframe<-data.frame()
  
 #Write AnimalID, genotype and TimeZone to current animal
        AnimalIDCurrent<-Fig1SummaryDataframe$AnimalID[i]
        GenotypeCurrent<-Fig1SummaryDataframe$Genotype[i]
        TimeZoneCurrent<-Fig1SummaryDataframe$TimeZone[i]
        DrugDateTimeCurrent<-Fig1SummaryDataframe$DrugDateTime[i] 
  #i. Set AnimalID subfolder
  
 FullPath<-paste(NDFDataParentFolder, AnimalIDCurrent, sep="/")
  
    #Next import all files in input_path to create a new r dataframe called             `SCPP1Dataframe'
    SCPP1Dataframe<-ImportData(FullPath)
  
  #Apend time information to Data frame  
    SCPP1Dataframe <- GetTimeOfDayAndDate(SCPP1Dataframe, TimeZoneCurrent)


    #Apend treatment variable 
    Treatment<-c()
    Treatment[which(SCPP1Dataframe$TimeOfDay<strptime(DrugDateTimeCurrent, "%d/%m/%y %H:%M:%S"))]="Control"
    Treatment[length(Treatment)+1]="Unknown"
    Treatment[(length(Treatment)+1):(dim(SCPP1Dataframe))[1]]="Drug"
    SCPP1Dataframe<-cbind(SCPP1Dataframe, Treatment)
    # Exclude Loss and Artifact intervals
    SCPP1Dataframe <- ExcludeIntervals(SCPP1Dataframe, 3)
    
    #Apend AnimalID variable
    AnimalIDVariable<-rep(AnimalIDCurrent, nrow(SCPP1Dataframe))
    SCPP1Dataframe<-cbind(SCPP1Dataframe, AnimalIDVariable)

     #Save SCPP1Dataframe to have current AnimalID and export
    SCPP1DataframeList[[AnimalIDCurrent]]<-SCPP1Dataframe
    SCPP1DataframeAll<-rbind(SCPP1DataframeAll, SCPP1Dataframe)
}


```

## Compare spike rate Data between animals in control condition 
An average spike rate over the recording is not informative. The readout we use is number of spikes/8s interval which is the spikeCount variable in SCPP1Dataframe.

First, Select for control/drug treatment condition
```{r SelectTreatmentCondition_Chunk, echo=FALSE}


SCPP1DataframeControl<-filter(SCPP1DataframeAll, Treatment=="Control")
SCPP1DataframeDrug<-filter(SCPP1DataframeAll, Treatment=="Drug")

```

To compare between animals/genotypes, we will use ECDF.


  iv. Create Data frame with empirical cumulative distribution for each animal in control conditions
```{r Create_ECDFs_chunk, echo=FALSE, include=FALSE}
ECDFList<-list()
ECDFAllCtrlDataframe<-data.frame()
for (j in 1:nrow(Fig1SummaryDataframe)){
  ECDFCurrent<-data.frame()
  AnimalIDCurrent<-Fig1SummaryDataframe$AnimalID[j]
  GenotypeCurrent<-Fig1SummaryDataframe$Genotype[j]
  DataframeCurrent<-filter(SCPP1DataframeControl, AnimalIDVariable==AnimalIDCurrent)
  
  ECDFCurrent <-CreateECDF(DataframeCurrent, GenotypeCurrent, AnimalIDCurrent)
  ECDFList[[Fig1SummaryDataframe$AnimalID[j]]]<-ECDFCurrent  #A list of all ECDFs for each animal. Accessed by AnimalIDs in Fig1SummaryDataframe$AnimalID
  ECDFAllCtrlDataframe<-rbind(ECDFAllCtrlDataframe, ECDFCurrent)
  }
```


```{r ECDF_PlotChunk, echo=FALSE, include=FALSE}  
  #Plot ECDF for all animals in control conditions


    #First, combine all elements of ECDFList into a single dataframe
    #ECDFAllCtrlDataframe<-rbindlist(ECDFList)


#Now create separate DFs for each genotype using filter
#ecdf_df_J20<-filter(ECDF_df_all, genotype=="J20")
#ecdf_df_WT<-filter(ECDF_df_all, genotype=="WT")

#ecdf_WT_plot<-ggplot(ecdf_df_WT, aes(x=spikeCount, y=CumFrequency, color=AnimalID))
#ecdf_WT_plot<-ecdf_WT_plot +
#geom_step() + xlab("Number of spikes") + ylab("Number of intervals") +

ECDFAllCtrlPlot<-ggplot(ECDFAllCtrlDataframe, aes(x=SpikeCount, y=CumFrequency, color=AnimalIDVariable))
ECDFAllCtrlPlot<-ECDFAllCtrlPlot + geom_step() + xlab("Number of spikes") + ylab("Number of intervals") + facet_wrap(~Genotype) +ggtitle("Cumulative frequency of Spike count/8s interval in control conditions")

ECDFAllCtrlPlot
#http://blog.amitsharma.in/2015/09/13/cumulative-distribution-plots-for-frequency-Data-in-r/

```

To compare between genotypes, for each animal, we extract the proportion of intervals with one or more than one spike.

``` {r ECDF_stats_chunk, ECHO=FALSE, include=FALSE}
#For each animal, evaluate the percentile of intervals with one or more spikes
for(i in 1:nrow(Fig1SummaryDataframe)){
  AnimalIDCurrent<-Fig1SummaryDataframe$AnimalID[i]
  ECDFCurrent<-filter(ECDFAllCtrlDataframe, AnimalIDVariable==AnimalIDCurrent)
  Fig1SummaryDataframe$Grtr1Spike[i]<-ECDFCurrent$CumFrequency[2]  #Percentage of intervals with 1 or more spikes for this animal
}
```


The number of intervals with more than 1 spike was compared between genotypes using a permutation test

#Summary statistics for percentage intervals with 1 or more spikes
```{r SummaryStatsChunk, echo=FALSE}
GroupedData<-group_by(Fig1SummaryDataframe, Genotype)
summarise(GroupedData, mean=mean(Grtr1Spike, na.rm=TRUE), sd=sd(Grtr1Spike, na.rm=TRUE))
```
#Permutation test to compare intervals with 1 or more spikes between genotypes

```{r Grtr1spike_PermutationTest_Chunk, echo=FALSE}

#Remove NAs
Fig1SummaryDataframeNoNA<-na.omit(Fig1SummaryDataframe)

#Compare PercGreaterOneSpike in WT and J20

Data<-Fig1SummaryDataframeNoNA$Grtr1Spike
Group<-Fig1SummaryDataframeNoNA$Genotype

#Permutation tests, two-sided hypothesis, with 4 methods of sampling
PermutationResults_pclt<-permTS(Data~Group,alternative="two.sided",method="pclt")
PermutationResults_exact.network<-permTS(Data~Group,alternative="two.sided",method="exact.network")
PermutationResults_exact.ce<-permTS(Data~Group,alternative="two.sided",method="exact.ce")
PermutationResults_exact.mc<-permTS(Data~Group,alternative="two.sided",method="exact.mc")
```


IGNORE this because an average spike rate isn't meaningful
Calculate spike rate as total number of spikes /(total intervals * 8s) 
```{r  Oldcodetoignore, echo=FALSE, include=FALSE}
###TO DO: 
#Plot
#REPORT SUMMARY STATS FOR TEST OF CHOICE
#WRITE UP AS WOULD BE IN PAPER TO ENSURE THAT YOU HAVE RELEVANT STATS
#for(i in 1:nrow(Fig1SummaryDataframe)){
  
#  SCPP1Dataframe_current<-SCPP1DataframeList[[i]]
##  SCPP1Dataframe_current<-filter(SCPP1Dataframe_current, #Treatment=="Control") #Select for control conditions
#  Fig1SummaryDataframe$SpikeRate_Control[i]<-CalculateSpikeRate(SCPP1Dataframe_current, 8)
  
#  SCPP1Dataframe_current<-filter(SCPP1Dataframe_current, Treatment=="Drug") #Select for Drug conditions
#  Fig1SummaryDataframe$SpikeRate_Control[i]<-CalculateSpikeRate(SCPP1Dataframe_current, 8)
  



```
##################
