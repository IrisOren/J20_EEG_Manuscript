
---
title: "J20_EEG_Manuscript"
author: "Iris Oren"
date: "19/12/2016"
output:
  html_document: default
  pdf_document: default
---


### Description
This .rmd file processes the Data to create all figures for Brown & Ying et a

* Data
  + Spike counts by SCPP1V1: SCPP1V1.tcl was run on 8s epochs of Data, with glitch=200. The processor generated text files, containing spike counts, theta and delta power. SCPP1V1.tcl outputs: "ndfFilename_SCPP1V1.txt", organised in individual folders by AnimalID (Raw Data: Dropbox/Analysis/Neuroarchiver/J20EEG/SCPP1V1).
  + Spike counts by Matthias's scripts: To be added
  + Metadata: RecordingInformationJ20_Saved180816.csv
  + Abeta load Data: to be added
  + Chat Data: to be added
  + AChE Data: to be added



###Package Initialisation 

First, load packages and source files
```{r LoadPackages_Chunk, echo=FALSE, include=FALSE}
library(lubridate)
library(dplyr)
library(lazyeval) #Needed for using ggplot2 library
library(ggplot2)
library(grid)
library(cowplot)
library(stringr)
library(scatterplot3d)
library(data.table)
library(perm)
library(circular)
library(plotrix)
library(readr)  #for col_skip in read.csv


sourceDir <- function(path, trace = TRUE, ...) {
    for (nm in list.files(path, pattern = "\\.[Rr]$")) {
       if(trace) cat(nm,":")           
       source(file.path(path, nm), ...)
       if(trace) cat("\n")
    }
}
sourceDir("R/")  #All function in R/ folder relative to project
```
### Datafile and variable initialisation
Specify files and folders to be used
```{r VariableInitialisationChunk, ECHO=FALSE}
NDFDataParentFolder<-"~/Dropbox/ANALYSIS/J20_EEG_Manuscript/Data/SCPP1V1_TCL"
RecordingInfoFile<-"./Data/RecordingInfo.csv"
#RecordingInfoFile<-"./Data/RecordingInfo_WT_VideoScoring.csv"
OutputFolder<-"./Output"
```

Import summary recording information dataframe
```{r ImportRecordingInformation, ECHO=FALSE, include=FALSE}

SummaryDataframe<-read.csv(RecordingInfoFile, na = "empty")
SummaryDataframe$AnimalID<-as.character(SummaryDataframe$AnimalID)
SummaryDataframe$DrugDate<-as.character(SummaryDataframe$DrugDate)
SummaryDataframe$DrugTime<-as.character(SummaryDataframe$DrugTime)
SummaryDataframe$TimeZone<-as.character(SummaryDataframe$TimeZone) #Set to "Europe/london" except for animals when clocks changed from GMT-> daylight savings and they stayed on GMT which should be set to "UTC" 
SummaryDataframe$DrugDateTime<-  paste(as.character(SummaryDataframe$DrugDate)
, as.character(SummaryDataframe$DrugTime), " ")


```


2. For each AnimalID:
  i. Set AnimalID subfolder
  ii. Create SCPPP1_dataframe from all NDFFileName_SCPP1V1.txt files 
  iii. Add variables for time and for separating drug and treatment conditions
  iv. Exclude loss intervals
  v. Save to a dataframe in long format. To access elements filter by AnimalID
  OR Import SCPP1DataframeAll.csv which has been created previously

  
  
```{r ImportAndTransformNDFOutput_chunk, ECHO=FALSE}
if(file.exists("./Output/SCPP1DataframeAll.csv")){
  SCPP1DataframeAll<-read.csv("./Output/SCPP1DataframeAll.csv")
  } else{  #Else create SCPP1DataframeAll.csv
    
      #Initialise variables for current subject
      SCPP1DataframeList<-list()
      SCPP1DataframeAll<-data.frame()
      
      #spikeCount_x <- c()
      #spikeCount_ID <- as.factor(c())
      #spikeCount_genotype <- as.factor(c())
      for(i in 1:nrow(SummaryDataframe)){     #Loop through animals
      
        SCPP1Dataframe<-data.frame()
        
       #Write AnimalID, genotype and TimeZone to variable for current animal
              AnimalIDCurrent<-SummaryDataframe$AnimalID[i]
              GenotypeCurrent<-SummaryDataframe$Genotype[i]
              TimeZoneCurrent<-SummaryDataframe$TimeZone[i]
              DrugDateTimeCurrent<-SummaryDataframe$DrugDateTime[i] 
        #i. Set AnimalID subfolder
        
          FullPath<-paste(NDFDataParentFolder, AnimalIDCurrent, sep="/")
       
       #Next import all files in input_path to create a new r dataframe called             `SCPP1Dataframe'
          SCPP1Dataframe<-ImportData(FullPath)
        
        #Apend time information to Data frame  
          SCPP1Dataframe <- GetTimeOfDayAndDate(SCPP1Dataframe, TimeZoneCurrent)
        #Apend a Treatment variable to the dataframe, based on DrugDateTime as specified in Fig1SummaryDataframe 
          Treatment<-c()
          Treatment[which(SCPP1Dataframe$TimeOfDay<strptime(DrugDateTimeCurrent, "%d/%m/%y %H:%M:%S"))]="Control"
          #If there are more intervals than control condition ie. if drug given
          if(length(Treatment)<nrow(SCPP1Dataframe)){
            Treatment[length(Treatment)+1]="Unknown"
            Treatment[(length(Treatment)+1):(dim(SCPP1Dataframe))[1]]="Drug"
          }
          #apend Treatment variable to SCPP1Dataframe
            SCPP1Dataframe<-cbind(SCPP1Dataframe, Treatment)
          # Exclude Loss and Artifact intervals
            SCPP1Dataframe <- ExcludeIntervals(SCPP1Dataframe, 3)
          
      #Apend AnimalID variable and Genotype
          AnimalIDVariable<-rep(AnimalIDCurrent, nrow(SCPP1Dataframe))
          SCPP1Dataframe<-cbind(SCPP1Dataframe, AnimalIDVariable)
          Genotype<-rep(GenotypeCurrent, nrow(SCPP1Dataframe))
          SCPP1Dataframe<-cbind(SCPP1Dataframe, Genotype)
      
       #Apend SCPP1Dataframe to SCPP1DataframeAll. To access an animal, used "filter()" 
          SCPP1DataframeAll<-rbind(SCPP1DataframeAll, SCPP1Dataframe)
      }
      
      
      #Save SCPP1DataframeAll to output directory
        write.csv(SCPP1DataframeAll, "./Output/SCPP1DataframeAll.csv")
  }
```

###########################################################
# Figure 1: Spike count measure between genotype

This figure requires a dataframe Fig1SummaryDataframe=AnimalID|Genotype|TimeZone|Spike rate measure = Number of intervals greater than 0 spikes

Steps:
1. Create Fig1SummaryDataframe from recordingInformation. 
```{r create_fig1_dataframe, ECHO=FALSE}
  Fig1SummaryDataframe<-SummaryDataframe[, c("AnimalID", "Genotype", "TimeZone", "DrugDateTime")]
#Remove rows with missing variables
  Fig1SummaryDataframe<-Fig1SummaryDataframe[complete.cases(Fig1SummaryDataframe),]
```
  


## Compare SpikeCount Data between animals in control condition 
An average spike rate over the recording is not informative. The readout we use is number of spikes/8s interval which is the spikeCount variable in SCPP1Dataframe.

First, Select for control/drug treatment condition
```{r SelectTreatmentCondition_Chunk, echo=FALSE}


SCPP1DataframeControl<-filter(SCPP1DataframeAll, Treatment=="Control")
SCPP1DataframeDrug<-filter(SCPP1DataframeAll, Treatment=="Drug")

```

To compare between animals/genotypes, we use ECDF.
  iv. Create Data frame with empirical cumulative distribution for each animal in control conditions
```{r Create_ECDFs_chunk, echo=FALSE, include=FALSE}

ECDFAllCtrlDataframe<-data.frame()

for (j in 1:nrow(Fig1SummaryDataframe)){
  ECDFCurrent<-data.frame()
  #Select animalID for current loop
    AnimalIDCurrent<-Fig1SummaryDataframe$AnimalID[j]
  #Select genotype for current loop which will be used for ECDF plot
  GenotypeCurrent<-Fig1SummaryDataframe$Genotype[j]
  #Filter for control conditions for AnimalIDCurrent only 
  DataframeCurrent<-filter(SCPP1DataframeControl, AnimalIDVariable==AnimalIDCurrent)
  
  #Create ECDF from current SCPP1 dataframe
  ECDFCurrent <-CreateECDF(DataframeCurrent, GenotypeCurrent, AnimalIDCurrent)
  #Save to dataframe for all animals to export
  ECDFAllCtrlDataframe<-rbind(ECDFAllCtrlDataframe, ECDFCurrent)
}

write.csv(ECDFAllCtrlDataframe, "./Output/ECDFAllCtrlDataframe.csv")
```

Plot ECDF for all animals in control conditions

```{r ECDF_PlotChunk, echo=TRUE, include=TRUE}  
ECDFAllCtrlPlot<-ggplot(ECDFAllCtrlDataframe, aes(x=SpikeCount, y=CumFrequency, color=AnimalIDVariable))
ECDFAllCtrlPlot<-ECDFAllCtrlPlot + geom_step() + xlab("Number of spikes") + ylab("Number of intervals") + facet_wrap(~Genotype) +ggtitle("Cumulative frequency of Spike count/8s interval in control conditions")


#http://blog.amitsharma.in/2015/09/13/cumulative-distribution-plots-for-frequency-Data-in-r/

ECDFAllCtrlPlot



```

To compare between genotypes, for each animal, we extract the proportion of intervals with more than 0 spikes and write it to Fig1SummaryDataframe as a new variable Grtr0Spikes.

``` {r ECDF_stats_chunk, ECHO=TRUE, include=TRUE}
#For each animal, evaluate the percentile of intervals with one or more spikes
for(i in 1:nrow(Fig1SummaryDataframe)){
  AnimalIDCurrent<-Fig1SummaryDataframe$AnimalID[i]
  ECDFCurrent<-filter(ECDFAllCtrlDataframe, AnimalIDVariable==AnimalIDCurrent)
  Fig1SummaryDataframe$Grtr0SpikeCtrl[i]<-1-(ECDFCurrent$CumFrequency[2]) 
}
Fig1SummaryDataframe
```



#Summary statistics for percentage intervals with 1 or more spikes
```{r SummaryStatsChunk, echo=FALSE, include=TRUE}
####NOTE:  TO ADD NORMALITY TESTS FOR REPORTING MEAN VS MEDIAN
#Summary statisitcs by genotype
SummarySE(Fig1SummaryDataframe, measurevar="Grtr0SpikeCtrl", groupvars=c("Genotype"), na.rm=TRUE)

Fig1SummaryDataframe_WT<-filter(Fig1SummaryDataframe, Genotype=="WT")
Fig1SummaryDataframe_J20<-filter(Fig1SummaryDataframe, Genotype=="J20")

#Normality testing using Shapiro-Wilk and QQ plots

DataForTesting <-Fig1SummaryDataframe_WT$Grtr0SpikeCtrl
  SW_WT<-NormTesting(DataForTesting, "QQPlot_WT")
  SW_WT
  
DataForTesting <-Fig1SummaryDataframe_J20$Grtr0SpikeCtrl
  SW_J20<-NormTesting(DataForTesting, "QQPlot_J20")
  SW_J20

```
#Permutation test to compare intervals with 1 or more spikes between genotypes

```{r Grtr0spike_PermutationTest_Chunk, echo=TRUE}



#Compare PercGreaterOneSpike in WT and J20

Data<-Fig1SummaryDataframe$Grtr0SpikeCtrl
Group<-Fig1SummaryDataframe$Genotype

#Permutation tests, two-sided hypothesis, with 4 methods of sampling


PermutationResults_exact.ce<-permTS(Data~Group,alternative="two.sided",method="exact.ce")
PermutationResults_exact.mc<-permTS(Data~Group,alternative="two.sided",method="exact.mc")
PermutationResults_exact.network<-permTS(Data~Group,alternative="two.sided",method="exact.network")
PermutationResults_pclt<-permTS(Data~Group,alternative="two.sided",method="pclt")

pCE<-PermutationResults_exact.ce$p.value
pEMC<-PermutationResults_exact.mc$p.value
pEN<-PermutationResults_exact.network$p.value
pPCLT<-PermutationResults_pclt$p.value

PrintVector<-data.frame("pCE"=pCE, "pEMC"=pEMC,"pEN"=pEN, "pCLT"=pPCLT)
PrintVector


```
The number of intervals with one or more spikes was compared between genotypes using a permutation test. There was a significant difference between genotypes in the % intervals with 1 or more spikes:
`r PrintVector`)



##Plotting % intervals > 0 spikes
```{r ScatterPlotChunk, echo=FALSE}
data<-Fig1SummaryDataframe$Grtr0SpikeCtrl
group<-Fig1SummaryDataframe$Genotype

stripchart(Grtr0SpikeCtrl ~ Genotype, data=Fig1SummaryDataframe,
           vertical = TRUE, method = "jitter", ylab="% intervals > 0 spikes",
            pch = 21, col = "maroon", bg = "bisque",
            add = FALSE)

```

#########################################################################
#Figure 2: IIS and time of day
Figure 2A: Example of circadian fluctuations in IIS from JF167

It has been suggested that seizure-related activity varies across the circadian cycle {Quigg:2000vq}. Looking at IIS times across several days suggested that IIS the IIS counts vary across the circadian cycle – with IIS occurring more frequently in the inactive phase (Fig 2A).

Plot example of circadian spike probability for JF167
```{r Fig2AIISTimesExample, echo=FALSE}


#Filter SCPP1DataFrameAll to select for JF167 
IISTimesJF167<-filter(SCPP1DataframeAll, AnimalIDVariable=="JF167")
# Select the relevant columns of dataframe
IISTimesJF167<-select(IISTimesJF167, SpikeCount, TimeOfDay)
#Filter for intervals with >0 IIS
IISTimesJF167<-filter(IISTimesJF167, SpikeCount>0)
#Convert the to Posixlt format
IISTimesJF167$TimeOfDay<-strptime(IISTimesJF167$TimeOfDay, "%Y-%m-%d %H:%M:%S")


## extract hour of IIS with lubridate function
IISTimesJF167$hour_of_event <- hour(IISTimesJF167$TimeOfDay)
# make a new dataframe with hour appended
EventData <- data.frame(DateTime = IISTimesJF167$TimeOfDay, EventHour = IISTimesJF167$hour_of_event)
# determine if event is in light hours
EventData$Light <- EventData$EventHour %in% seq(7, 18)

  #Shift the event hour by 0.5 because having interger times was giving binning problems at 0 bins
    EventData$EventHourShifted<-EventData$EventHour+0.5


#Make circular plot
fontsize=18

Fig2A<-ggplot(EventData, aes(x = EventHourShifted, fill = Light)) +
  geom_histogram(breaks = seq(0,   24), binwidth = 2, colour = "grey") + 
  coord_polar(start = 0) + 
  theme_minimal() + 
  scale_fill_grey(labels=c("Off", "On")) + 
  ylab("Count") + 
  ggtitle("IIS by Time of day") + 
  theme(plot.title = element_text (size = fontsize))+
  theme(axis.title.y=element_text (size = fontsize))+
  theme(axis.text.y =element_text (size = fontsize))+
  theme(axis.text.x =element_text (size = fontsize))+
  scale_x_continuous("", limits = c(0, 24), breaks = seq(0, 24), labels = seq(0,24))


print(Fig2A)

```

Figure 2B:
We used circular statistics to establish whether IIS were significantly-coupled to a phase of the circadian cycle within individual animals (Fig 2A, see methods). 

###1. Create Fig2SummaryDataframe from recordingInformation. 
```{r create_fig2_dataframe, ECHO=FALSE, include=FALSE}
  Fig2SummaryDataframe <- SummaryDataframe[, c("AnimalID", "Genotype", "TimeZone")]
#Remove rows with missing variables
  Fig2SummaryDataframe <- Fig2SummaryDataframe[complete.cases(Fig2SummaryDataframe),]
```
  
###2. Calculate summary statistics for all animals
```{r Fig2BCircularStatsSummary}
# Select the relevant columns of dataframe
IISTimes<-select(SCPP1DataframeAll, SpikeCount, InitialisedTime, 
                 TimeOfDay, AnimalIDVariable)
#Filter for intervals with >0 IIS
IISTimes<-filter(IISTimes, SpikeCount>0)
#Convert all IIS times to radian angles
IISTimes$IISAngles<-ConvertToRadians(IISTimes$InitialisedTime)


  
#For each animalID, calculate summary stats and write to Fig2SummaryStats
for(i in 1:nrow(Fig2SummaryDataframe)){
  AnimalIDCurrent<-Fig2SummaryDataframe$AnimalID[i]
  IISTimesCurrent<-filter(IISTimes, AnimalIDVariable==AnimalIDCurrent)
  SummaryCircStatsCurrent<-SummaryCircStats(IISTimesCurrent$IISAngles)
  
  #Write summary circular stats to Fig2SummaryDataframe
  Fig2SummaryDataframe$MeanAngle[i]<-SummaryCircStatsCurrent$MeanAngle[1]
  Fig2SummaryDataframe$Rho[i]<-SummaryCircStatsCurrent$Rho[1]
  Fig2SummaryDataframe$SDAngle[i]<-SummaryCircStatsCurrent$SDAngle[1]
  Fig2SummaryDataframe$RayleighR[i]<-SummaryCircStatsCurrent$RayleighR[1]
  Fig2SummaryDataframe$RayleighP[i]<-SummaryCircStatsCurrent$RayleighP[1]
  AnimalIDCurrent<-c()
  IISTimesCurrent<-c()
  SummaryCircStatsCurrent<-c()
  
  #Convert from radians to time
  Fig2SummaryDataframe$MeanTimeSecs<-ConvertToSeconds(Fig2SummaryDataframe$MeanAngle)
  Fig2SummaryDataframe$SDSecs<-ConvertToSeconds(Fig2SummaryDataframe$SDAngle)
#Convert from unix time to time of day
  TempTimeDataframe<-ConvertUnixSecondsToTimeOfDay(Fig2SummaryDataframe$MeanTimeSecs)
  Fig2SummaryDataframe$MeanDateTime<-TempTimeDataframe$TimeOfDay
  Fig2SummaryDataframe$MeanTimeSeconds<-TempTimeDataframe$TimeOfDayTimeFormat

  #Calculate number of J20s that showed significant phasecoupling
  Fig2SummaryDataframe_J20<-filter(Fig2SummaryDataframe, Genotype=="J20")
  
}

```


```{r SampleSummaryStats, echo=FALSE, include=FALSE}
SampleMeanAngle<-mean.circular(Fig2SummaryDataframe_J20$MeanAngle)
if(SampleMeanAngle<0){
  SampleMeanAngle<-SampleMeanAngle+(2*pi)
}
SampleMeanTimeSeconds<-ConvertToSeconds(SampleMeanAngle)
SampleMeanDateTime<-ConvertUnixSecondsToTimeOfDay(SampleMeanTimeSeconds)

SampleMeanDeviation<-meandeviation(Fig2SummaryDataframe_J20$MeanAngle)

```

###3. Plot polar histograms for all J20s
```{r SpikeHist_Chunk, echo=FALSE}

for(i in 1:nrow(Fig2SummaryDataframe_J20)){
    AnimalIDCurrent=Fig2SummaryDataframe_J20$AnimalID[i]
    #Filter SCPP1DataFrameAll to select for JF167 
    IISTimesCurrent<-filter(SCPP1DataframeAll, AnimalIDVariable==AnimalIDCurrent)
    # Select the relevant columns of dataframe
    IISTimesCurrent<-select(IISTimesCurrent, SpikeCount, TimeOfDay)
    #Filter for intervals with >0 IIS
    IISTimesCurrent<-filter(IISTimesCurrent, SpikeCount>0)
    #Convert the to Posixlt format
    IISTimesCurrent$TimeOfDay<-strptime(IISTimesCurrent$TimeOfDay, "%Y-%m-%d %H:%M:%S")
    
    
    ## extract hour of IIS with lubridate function
    IISTimesCurrent$hour_of_event <- hour(IISTimesCurrent$TimeOfDay)
    # make a new dataframe with hour appended
    EventData <- data.frame(DateTime = IISTimesCurrent$TimeOfDay, EventHour = IISTimesCurrent$hour_of_event)
    # determine if event is in light hours
    EventData$Light <- EventData$EventHour %in% seq(7, 18)
    
   
    
    #Shift the event hour by 0.5 because having interger times was giving binning problems at 0 bins
    EventData$EventHourShifted<-EventData$EventHour+0.5
    
    #Make circular plot
    fontsize=18
    #Filename for saving
    names<-Fig2SummaryDataframe_J20$AnimalID
    filename<-paste("./Output/", names[i],"_SpikeHist",".jpg", sep="")
    
    SpikeHist<-ggplot(EventData, aes(x = EventHourShifted, fill = Light)) +
      geom_histogram(breaks = seq(0,   24), binwidth = 2, colour = "grey") +   coord_polar(start = 0) + 
      theme_minimal() + 
      scale_fill_grey(labels=c("Off", "On")) + 
      ylab("Count") + 
      ggtitle(paste(AnimalIDCurrent, as.character(round(Fig2SummaryDataframe$RayleighP[i], 3)), as.character(round(Fig2SummaryDataframe$RayleighR[i], 3)))) + 
      theme(plot.title = element_text (size = fontsize))+
      theme(axis.title.y=element_text (size = fontsize))+
      theme(axis.text.y =element_text (size = fontsize))+
      theme(axis.text.x =element_text (size = fontsize))+
      scale_x_continuous("", limits = c(0, 24), breaks = seq(0, 24), labels = seq(0,24))
    
    
    
    jpeg(file=filename)
    print(SpikeHist)
    dev.off()
}
```

###4. Determine phase coupling of strength and compare between WT and J20. Hypothesis testing
To quantify the coupling of IIS to the day-night cycle, we calculated the circular mean angle and dispersion, and Rayleigh probability for all J20s.

```{r CompareRhoBtwnGenotypes, echo=FALSE, include=FALSE}

#t-test to get CI
t<-t.test(Fig2SummaryDataframe_J20$Rho)


```


`r sum(Fig2SummaryDataframe_J20$RayleighP<0.05)` of `r nrow(Fig2SummaryDataframe_J20)' ) animals exhibited significant phase coupling of IIS as estimated by the Rayleigh test (p=(`r min(Fig2SummaryDataframe_J20$RayleighP) -- max(Fig2SummaryDataframe_J20$RayleighP)`. The degree of phase coupling varied between animals as can be seen in the distribution of the angular dispersion, rho= `r(round(mean(Fig2SummaryDataframe$Rho, 2) CI=t$conf.int)`.



```{r PolarPlotRhoMeanAngleJ20, echo=FALSE, include=FALSE}
SampleRhoMeanAngle<-radial.plot(Fig2SummaryDataframe_J20$Rho, Fig2SummaryDataframe_J20$MeanAngle, start=(pi/2), clockwise = TRUE, labels=c("0/24h","6h", "12h", "18h"), label.pos = c(0, (pi/2), pi, (3*pi/2)), label.prop=1.4, rp.type = "s", point.symbols = 20, show.radial.grid = TRUE, radial.lim = c(0, 0.25, 0.5))

print(SampleRhoMeanAngle)
```

Across the sample of J20s, the IIS was significantly coupled to light periods (Phi_J20=`r SampleMeanDateTime$TimeOfDay`.




#########################################################################
##Figure 3: Probability of IIS and brain state
Since IIS occurred preferentially in the light, we hypothesised that IIS occur preferentially during sleep. The ratio of theta to delta power has been used previously to characterise the animal's behavioural state. 

#### Theta/delta to characterise behavioural state
1. Import VideoTimes.csv
```{r ImportVideoTimes, echo=FALSE, include=False}
VideoTimesFilename<-"./Data/VideoTimesSummary.csv"
VideoTimes<-read.csv(VideoTimesFilename)
TempTimes<-strptime(as.character(VideoTimes$VideoStartTime), "%d/%m/%Y %H:%M:%S")
VideoTimes$VideoStartTimeLinux<-(as.numeric(as.POSIXct(TempTimes)))

TempTimes<-strptime(as.character(VideoTimes$VideoEndTime), "%d/%m/%Y %H:%M:%S")
VideoTimes$VideoEndTimeLinux<-(as.numeric(as.POSIXct(TempTimes)))

```



2. Make SCPP1 Dataframe for individual animals
```{r MakeAnimalDataframe, echo=FALSE, include=FALSE}
SCPP1DataframeJF220<-filter(SCPP1DataframeAll, AnimalIDVariable=="JF220")
SCPP1DataframeJF221<-filter(SCPP1DataframeAll, AnimalIDVariable=="JF221")
SCPP1DataframeJF373<-filter(SCPP1DataframeAll, AnimalIDVariable=="J0373")
SCPP1DataframeJF375<-filter(SCPP1DataframeAll, AnimalIDVariable=="J0375")
SCPP1DataframeJF376<-filter(SCPP1DataframeAll, AnimalIDVariable=="J0376")

```

3. Import VideoScoring dataframe and amend with UnixTime for JF220
```{r MakeVideoScoringDataframe, echo=FALSE, include=FALSE}

FileList<-c("./Data/VideoScoring/VideoScoringJF220_040416.csv",
            "./Data/VideoScoring/VideoScoringJF220_050416.csv",   
            "./Data/VideoScoring/VideoScoringJF220_060416.csv",  
            "./Data/VideoScoring/VideoScoringJF220_070416.csv",
            "./Data/VideoScoring/VideoScoringJF220_080416.csv", 
            "./Data/VideoScoring/VideoScoringJ0373_030816Day.csv",
            "./Data/VideoScoring/VideoScoringJ0373_030816Night.csv",
            "./Data/VideoScoring/VideoScoringJ0375_120816Day.csv",
            "./Data/VideoScoring/VideoScoringJ0375_120816Night.csv",
            "./Data/VideoScoring/VideoScoringJ0376_140816Day.csv",
            "./Data/VideoScoring/VideoScoringJF221_040416.csv",
            "./Data/VideoScoring/VideoScoringJF221_050416.csv",
            "./Data/VideoScoring/VideoScoringJF221_060416.csv",
            "./Data/VideoScoring/VideoScoringJF221_080416.csv"
          )


AnimalIDList<-c("JF220", "JF220", "JF220", "JF220", "JF220",
               "J0373", "J0373",
               "J0375", "J0375", 
              "J0376", 
              "JF221", "JF221", 
             "JF221", "JF221"
            )
SCPP1DataframeVideoTimesAll<-data.frame()
AnimalIDVideoStartEnd<-list() #A list to store Start and End times for video data. The list index is AnimalID_FileIndex eg. JF220_1

for(FileIndex in 1:length(FileList)){
   # VideoScoringFilename<-"./Data/VideoScoringJF220_040416.csv"
   VideoScoringFilename<-FileList[[FileIndex]] 
   #Date<-DateList[[FileIndex]]
   AnimalIDCurrent<-AnimalIDList[[FileIndex]]
   
    #Import
    VideoScoring<- read.csv(VideoScoringFilename)
    VideoScoring<-select(VideoScoring, DateOfEEG, TimeOfEEG, Behaviour, SleepWake)
    VideoScoring$SleepWake<-as.character(VideoScoring$SleepWake) #needs to be character. "as.factor" converts to numeric factors
    
    #Add date to Time to make TimeString
    VideoScoring$DateTime<-paste(VideoScoring$DateOfEEG, VideoScoring$TimeOfEEG)
    
    VideoScoring$DateTime<-strptime(as.character(VideoScoring$DateTime), "%d/%m/%y %H:%M:%S")
    
    #Convert to UnixTime
    VideoScoring$UnixTime<-(as.numeric(as.POSIXct(VideoScoring$DateTime)))
    
    #Determine Start and End time of video file for particular day
    VideoStartTime<-VideoScoring$UnixTime[1]
    VideoEndTime<-VideoScoring$UnixTime[nrow(VideoScoring)]
    
    #Create vector with videostart and videoend variables for this FileIndex iteration
    AnimalIDVideoStartEndVectorCurrent<-c(as.numeric(VideoStartTime), as.numeric(VideoEndTime))
    
    ListIndex<-paste(AnimalIDCurrent, as.character(FileIndex), sep="_")
    AnimalIDVideoStartEnd[[ListIndex]]<-AnimalIDVideoStartEndVectorCurrent
    
    #Filter SCPP1 between start and endtime of video for particular day

SCPP1DataframeVideoTimes<-filter(SCPP1DataframeAll, AnimalIDVariable==AnimalIDCurrent)
SCPP1DataframeVideoTimes<-filter(SCPP1DataframeVideoTimes, InitialisedTime>=VideoStartTime)
    SCPP1DataframeVideoTimes<-filter(SCPP1DataframeVideoTimes, InitialisedTime<=VideoEndTime)
    
    
    #Add video score to dataframe for which video is available
    
    SCPP1DataframeVideoTimes$SleepWake<-AddVideoScoreToSCPP1Data(SCPP1DataframeVideoTimes$InitialisedTime, VideoScoring$UnixTime, VideoScoring$SleepWake)
    SCPP1DataframeVideoTimesAll<-rbind(SCPP1DataframeVideoTimesAll, SCPP1DataframeVideoTimes)
  
}

```

4. Compute Theta/Delta for SCPP1DataframeJF220VideoTimes
```{r ComputeThetaDelta, echo=FALSE, include=FALSE}
SCPP1DataframeVideoTimesAll$ThetaOverDelta<-SCPP1DataframeVideoTimesAll$Theta/SCPP1DataframeVideoTimesAll$Delta
```

5. Exclude NAs, Loss intervals and extremes of delta power (artifacts). We exclude delta power>5 sds away from mean delta
```{r ExcludeEpochs, echo=FALSE, include=FALSE}
#Excluded values are omitted from Dataframe. This means that data points can no longer be coerced into time series object
SCPP1DataframeVideoTimesAllExcluded<-ExcludeIntervals(SCPP1DataframeVideoTimesAll, 5)
NumberOfExcludedIntervals<-nrow(SCPP1DataframeVideoTimesAll)-nrow(SCPP1DataframeVideoTimesAllExcluded)
```

No. of excluded intervals:`r NumberOfExcludedIntervals`

5. Plot theta/delta and sleep wake against time. The chunk iterates through all animals and saves output plots into folder ./Output/ThetaDeltaBehavioralState

```{r, PlotThetaDeltaSW_all, echo=FALSE, include=FALSE}

      for(FileIndex in 1:length(AnimalIDVideoStartEnd)){ #Loop through all video files from video start to end and plot
        AnimalIDCurrent<-AnimalIDList[[FileIndex]]
        ListID<-paste(AnimalIDCurrent, as.character(FileIndex), sep="_")
      
      Theta<-ggplot(filter(SCPP1DataframeVideoTimesAllExcluded, AnimalIDVariable==AnimalIDCurrent), aes(x=InitialisedTime, y=Theta))+geom_point()+xlim(AnimalIDVideoStartEnd[[ListID]])+ggtitle(ListID)
      
      Delta<-ggplot(filter(SCPP1DataframeVideoTimesAllExcluded, AnimalIDVariable==AnimalIDCurrent), aes(x=InitialisedTime, y=Delta))+geom_point()+xlim(AnimalIDVideoStartEnd[[ListID]])
      
      ThetaOverDelta<-ggplot(filter(SCPP1DataframeVideoTimesAllExcluded, AnimalIDVariable==AnimalIDCurrent), aes(x=InitialisedTime, y=ThetaOverDelta))+geom_point()+xlim(AnimalIDVideoStartEnd[[ListID]])+ylim(0, 5)
      
      SleepWake<-ggplot(filter(SCPP1DataframeVideoTimesAllExcluded,
                               AnimalIDVariable==AnimalIDCurrent),
                        aes(x=InitialisedTime,
                            y=SleepWake)) + 
        geom_point()+
        xlim(AnimalIDVideoStartEnd[[ListID]])
      
      
      FileName<-paste("./Output/ThetaDeltaBehaviouralState/", "ThetaDeltaBehaviouralState",ListID,".jpg", sep="")

    PlotGridSave<-plot_grid(Theta, Delta, ThetaOverDelta, SleepWake, align = "v", nrow = 4)
  
 if(dir.exists("./Output/ThetaDeltaBehaviouralState")==FALSE) {
   dir.create("./Output/ThetaDeltaBehaviouralState")
 }
  jpeg(filename=FileName)
  print(PlotGridSave)
  dev.off()
      
}

#


```
To do:
Create loop for plotting SW and theta/delta
Check theta/delta/behaviour time info correct for J0XXX animals
Create training and test data sets for theta/delta/behaviour 
Decide on how to do IIS and theta/delta

####IIS and theta/delta
1. Distribution of theta power


###

